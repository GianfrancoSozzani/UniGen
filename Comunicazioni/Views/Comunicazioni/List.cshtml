@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model List<IGrouping<Guid, Comunicazioni.Models.Entities.Comunicazione>>

<h1>Comunicazioni</h1>
<div class="row gx-5">
	<div class="col-9">
		<table class="table">
			<thead>
				<tr>
					<th>Ruolo Mittente</th>
					<th>Comunicazione</th>
				</tr>
			</thead>
			<tbody>
				@foreach (var gruppo in Model)
				{
					<tr>
						<td>
							@gruppo.First().Soggetto
						</td>
						<td>
							<div class="accordion" id="accordionExample">
								<div class="accordion-item">
									<h2 class="accordion-header">
										<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_@gruppo.Key" aria-expanded="true" aria-controls="collapse_@gruppo.Key">
											Comunicazione numero: @gruppo.Key
											@*  .Key è in comando Linq per indicare la chiavbe usata per il group by  *@
										</button>
									</h2>
									<div id="collapse_@gruppo.Key" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
										<div class="accordion-body">
											<div class="col-md-6 col-lg-7 col-xl-8">
												<ul class="list-unstyled">
													@{
														var ruolo = Context.Session.GetString("ruolo");
													}
													@foreach (var comunicazione in gruppo.OrderBy(c => c.DataOraComunicazione))
													{
														<li class="d-flex justify-content-between mb-4">
															<div class="card">
																<div class="card-header d-flex justify-content-between p-3">
																	<div class="d-flex justify-content-between align-items-baseline">
																		<p class="fw-bold mb-0">
																			@if (comunicazione.Studente != null && comunicazione.Studente.K_Studente == comunicazione.K_Soggetto)
																			{
																				<span class="text-primary">@($"{comunicazione.Studente.Nome} {comunicazione.Studente.Cognome} (Studente)")</span>
																			}
																			else if (comunicazione.Docente != null && comunicazione.Docente.K_Docente == comunicazione.K_Soggetto)
																			{
																				<span class="text-danger">@($"{comunicazione.Docente.Nome} {comunicazione.Docente.Cognome} (Docente)")</span>
																			}
																			else
																			{
																				<span class="text-success">Amministrazione</span>
																			}
																			- @comunicazione.Soggetto
																		</p>
																		<span class="px-2"></span>
																		<p class="text-muted small mb-0"><i class="far fa-clock"></i>@comunicazione.DataOraComunicazione</p>
																	</div>
																</div>
																<div class="card-body">
																	<p class="mb-0">
																		@comunicazione.Testo
																	</p>
																</div>
															</div>
														</li>
													}
													<li class="bg-white">
														<form method="post" asp-action="AddRisposta">
															<input type="hidden" name="Codice_Comunicazione" value="@gruppo.Key" />
															@{
																var ultimoMessaggio = gruppo.Last();
																Guid? altroUtenteStudenteId = null;
																Guid? altroUtenteDocenteId = null;
																bool rispostaAdAmministrazione = false;

																if (ultimoMessaggio.Studente != null && ultimoMessaggio.Studente.K_Studente == ultimoMessaggio.K_Soggetto)
																{
																	// L'ultimo messaggio è di uno studente, la risposta sarà a un docente (se presente) o all'amministrazione
																	altroUtenteDocenteId = gruppo.FirstOrDefault(c => c.Docente != null && c.Docente.K_Docente != ultimoMessaggio.K_Soggetto)?.Docente?.K_Docente;
																	if (altroUtenteDocenteId == null && !gruppo.Any(c => c.Soggetto == "A"))
																	{
																		rispostaAdAmministrazione = true;
																	}
																}
																else if (ultimoMessaggio.Docente != null && ultimoMessaggio.Docente.K_Docente == ultimoMessaggio.K_Soggetto)
																{
																	// L'ultimo messaggio è di un docente, la risposta sarà a uno studente (se presente) o all'amministrazione
																	altroUtenteStudenteId = gruppo.FirstOrDefault(c => c.Studente != null && c.Studente.K_Studente != ultimoMessaggio.K_Soggetto)?.Studente?.K_Studente;
																	if (altroUtenteStudenteId == null && !gruppo.Any(c => c.Soggetto == "A"))
																	{
																		rispostaAdAmministrazione = true;
																	}
																}
																else // L'ultimo messaggio è dell'amministrazione
																{
																	// La risposta dell'amministrazione sarà all'ultimo studente o docente che ha scritto
																	altroUtenteStudenteId = gruppo.LastOrDefault(c => c.Studente != null && c.Studente.K_Studente != ultimoMessaggio.K_Soggetto)?.Studente?.K_Studente;
																	altroUtenteDocenteId = gruppo.LastOrDefault(c => c.Docente != null && c.Docente.K_Docente != ultimoMessaggio.K_Soggetto)?.Docente?.K_Docente;
																}

																<input type="hidden" name="K_DestinatarioStudente" value="@altroUtenteStudenteId" />
																<input type="hidden" name="K_DestinatarioDocente" value="@altroUtenteDocenteId" />
																<input type="hidden" name="RispostaAdAmministrazione" value="@rispostaAdAmministrazione" />
															}
															<div data-mdb-input-init class="form-outline">
																<textarea class="form-control bg-body-tertiary" id="textAreaExample2" rows="4" name="Testo"></textarea>
																<label class="form-label" for="textAreaExample2">Message</label>
															</div>
															<button type="submit" data-mdb-button-init data-mdb-ripple-init class="btn btn-info btn-rounded float-end p-0 px-2">Send</button>
														</form>
													</li>
												</ul>
											</div>
										</div>
									</div>
								</div>
							</div>
						</td>
					</tr>
				}
			</tbody>
		</table>
	</div>
	<div class="col-3 shadow p-3 bg-body-tertiary rounded">In questa pagina </div>
</div>